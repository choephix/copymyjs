---
import Layout from './Layout.astro';
import { getCollection } from 'astro:content';

const { frontmatter, headings } = Astro.props;
const posts = await getCollection('blog');
const now = new Date();

// Filter out drafts and future posts
const publishedPosts = posts.filter(post => {
  if ('draft' in post.data && post.data.draft === true) return false;
  const publishDate = new Date(post.data.publishDate);
  return publishDate <= now;
}).sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime());
---

<Layout title={frontmatter.title}>
  <div class="flex">
    <!-- Sidebar -->
    <aside class="w-64 h-screen sticky top-0 p-6 bg-gray-900 border-r border-gray-800 overflow-y-auto">
      <a href="/" class="block mb-8 text-xl font-bold text-white">
        Copy<span class="text-[#f7df1e]">My</span><span class="text-[#3178c6]">JS</span>
      </a>
      
      <nav>
        <ul class="space-y-6">
          {publishedPosts.map(post => (
            <li>
              <a 
                href={`/blog/${post.slug}`}
                class:list={[
                  'block text-sm hover:text-white transition-colors',
                  post.slug === Astro.params.slug ? 'text-white font-medium' : 'text-gray-400'
                ]}
              >
                {post.data.title}
              </a>
              
              {post.slug === Astro.params.slug && headings.length > 0 && (
                <ul class="mt-2 ml-4 space-y-2">
                  {headings.filter(h => h.depth === 2).map(heading => (
                    <li>
                      <a 
                        href={`#${heading.slug}`}
                        class="block text-xs text-gray-500 hover:text-gray-300 transition-colors"
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))}
        </ul>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 max-w-3xl mx-auto px-8 py-12">
      <article class="prose prose-invert">
        <h1 class="text-4xl font-bold mb-4">{frontmatter.title}</h1>
        <p class="text-gray-400 mb-8">Published on {frontmatter.publishDate}</p>
        <slot />
      </article>
    </main>
  </div>
</Layout>

<style is:global>
  .prose {
    color: #fff;
    max-width: none;
  }
  .prose h1, .prose h2, .prose h3 {
    color: #fff;
    margin-top: 2rem;
    margin-bottom: 1rem;
    scroll-margin-top: 2rem;
  }
  .prose p {
    margin-bottom: 1rem;
  }
  .prose code {
    color: #e2e8f0;
  }
</style>